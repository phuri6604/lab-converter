<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Converter</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 950px; margin: 20px auto; padding: 20px; color: #333; line-height: 1.5; }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8eaed; padding-bottom: 10px; }
        textarea { width: 100%; height: 300px; font-family: 'Consolas', monospace; padding: 15px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; background: #fdfdfd; }
        textarea:focus { border-color: #1a73e8; outline: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 14px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; color: white; }
        .btn-convert { background: #1a73e8; }
        .btn-convert:hover { background: #1557b0; }
        .btn-copy { background: #5f6368; }
        .btn-copy:hover { background: #4a4d51; }
        .btn-copy.copied { background: #28a745 !important; }
        .btn-clear { background: #d93025; }
        .btn-clear:hover { background: #b71c1c; }
        pre { background: #f1f3f4; padding: 20px; margin-top: 20px; white-space: pre-wrap; border-radius: 8px; border-left: 6px solid #1a73e8; font-size: 16px; font-weight: 500; color: #202124; min-height: 50px; position: relative; }
        .label-hint { font-size: 0.85em; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<h2>Lab & Vital Sign Converter</h2>
<div class="label-hint">วางผล LAB</div>
<textarea id="input" placeholder="วางผลแล็บที่นี่..."></textarea>

<div class="btn-group">
    <button class="btn-convert" onclick="convert()">Convert</button>
    <button id="copyBtn" class="btn-copy" onclick="copyToClipboard()">Copy</button>
    <button class="btn-clear" onclick="clearAll()">Clear All</button>
</div>

<pre id="output"></pre>

<script>
function convert() {
    let rawText = document.getElementById("input").value;
    let textForLab = rawText;

    // 1. [CRITICAL] ล้าง Reference Range และ Tag [ High ] / [ Low ] ออกก่อน
    textForLab = textForLab.replace(/\([^)]*\)/g, ' '); 
    textForLab = textForLab.replace(/\[[^\]]*\]/g, ' ');
    textForLab = textForLab.replace(/,/g, '');
    textForLab = textForLab.replace(/\*/g, ''); // ลบดาว ***

    const results = {};
    const diff = {};

    // --- ส่วนที่ 1: Vital Sign Parser (ตัด SpO2) ---
    const vsRegex = /(\d{2}\.\d)\s+(\d{1,3})\s+(\d{1,3})\s+(\d{1,3})\s+.*?\s+(\d{2,3}\/\d{2,3})/;
    const vsMatch = rawText.match(vsRegex);
    if (vsMatch) {
        results["BT"] = vsMatch[1];
        results["HR"] = vsMatch[2];
        results["RR"] = vsMatch[3];
        results["BP"] = vsMatch[5];
    }

    // --- ส่วนที่ 2: Differential Parser ---
    const diffMapping = { "Neutrophil": "N", "Lymphocyte": "L", "Monocyte": "M", "Eosinophil": "E", "Basophil": "B" };
    for (let key in diffMapping) {
        const regex = new RegExp(key + "[^0-9]*(\\d+)", "i");
        const match = textForLab.match(regex);
        if (match && !textForLab.substring(match.index - 20, match.index).includes("NRC")) {
            diff[diffMapping[key]] = match[1];
        }
    }

    // --- ส่วนที่ 3: Lab Parser ---
    const labDefinitions = [
        { key: "Hemoglobin", label: "Hb" },
        { key: "Hematocrit", label: "Hct" },
        { key: "WBC", label: "WBC" },
        { key: "Platelet", label: "Plt" },
        { key: "Blood Urea Nitrogen", label: "BUN" },
        { key: "Creatinine", label: "Cr" },
        { key: "eGFR", label: "eGFR" },
        { key: "Sodium", label: "Na" },
        { key: "Potassium", label: "K" },
        { key: "Chloride", label: "Cl" },
        { key: "TCO2", label: "TCO2" },
        { key: "Lactate", label: "Lactate" },
        { key: "Total Protein", label: "Protein" },
        { key: "Albumin", label: "Alb" },
        { key: "Globulin", label: "Glb" },
        { key: "Direct Bilirubin", label: "DB" },
        { key: "Total Bilirubin", label: "TB" },
        { key: "Alkaline Phosphatase", label: "ALP" },
        { key: "SGOT", label: "AST" }, { key: "AST", label: "AST" },
        { key: "SGPT", label: "ALT" }, { key: "ALT", label: "ALT" }, { key: "SGPT2", label: "ALT" }, // รองรับ SGPT2
        { key: "Spgr", label: "sp.gr." },
        { key: "pH", label: "pH" },
        { key: "PT", label: "PT" },
        { key: "APTT", label: "aPTT" },
        { key: "INR", label: "INR" }
    ];

    labDefinitions.forEach(item => {
        const regex = new RegExp("\\b" + item.key + "\\b[^0-9]*(\\d+\\.?\\d*)", "i");
        const match = textForLab.match(regex);
        if (match) {
            let val = match[1];
            if (item.label === "WBC") {
                let num = parseFloat(val);
                if (num < 100) num *= 1000;
                results["WBC"] = Math.round(num);
            } else {
                results[item.label] = val;
            }
        }
    });

    // --- ส่วนที่ 4: UA Parser ---
    const uaKeys = { "Protein": "UA Prot", "Glucose": "UA Glu", "Ketone": "UA Ketone", "Blood": "UA Blood" };
    for (let key in uaKeys) {
        const regex = new RegExp(key + "[^a-zA-Z0-9]*(Neg|neg|Positive|\\d\\+)", "i");
        const match = textForLab.match(regex);
        if (match) {
            results[uaKeys[key]] = match[1].toLowerCase() === "neg" ? "neg" : match[1];
        }
    }

    // --- ส่วนที่ 5: จัดลำดับ Output ---
    let outputArr = [];
    const displayOrder = [
        "BT", "HR", "RR", "BP", 
        "Hb", "Hct", "WBC", "Plt", 
        "BUN", "Cr", "eGFR", "Na", "K", "Cl", "TCO2", "Lactate",
        "Protein", "Alb", "Glb", "TB", "DB", "AST", "ALT", "ALP",
        "sp.gr.", "pH", "UA Prot", "UA Glu", "UA Ketone", "UA Blood", 
        "PT", "aPTT", "INR"
    ];

    displayOrder.forEach(label => {
        if (results[label]) {
            if (label === "WBC") {
                const dOrder = ["N", "L", "M", "E", "B"];
                const dStr = dOrder.filter(k => diff[k]).map(k => k + diff[k] + "%").join(", ");
                outputArr.push(dStr ? `WBC ${results["WBC"]} (${dStr})` : `WBC ${results["WBC"]}`);
            } else {
                outputArr.push(`${label} ${results[label]}`);
            }
        }
    });

    let finalStr = outputArr.join(", ");
    if (!results["PT"]) {
        finalStr = finalStr.replace(/INR [\d.]+(, )?/, "").replace(/, $/, "");
    }

    document.getElementById("output").textContent = finalStr || "ไม่พบข้อมูลที่ต้องการแปลง";
}

function clearAll() {
    document.getElementById("input").value = "";
    document.getElementById("output").textContent = "";
    const copyBtn = document.getElementById("copyBtn");
    copyBtn.textContent = "Copy";
    copyBtn.classList.remove("copied");
}

function copyToClipboard() {
    const text = document.getElementById("output").textContent;
    if (!text || text === "ไม่พบข้อมูลที่ต้องการแปลง") return;

    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById("copyBtn");
        btn.textContent = "Copied!";
        btn.classList.add("copied");
        setTimeout(() => {
            btn.textContent = "Copy";
            btn.classList.remove("copied");
        }, 2000);
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab Converter Pro</title>

<style>
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        max-width: 900px; 
        margin: 20px auto; 
        padding: 0 20px;
        color: #333; 
        line-height: 1.6;
    }
    h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    textarea { 
        width: 100%; 
        height: 300px; 
        font-family: 'Courier New', monospace; 
        padding: 15px; 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        box-sizing: border-box;
        font-size: 14px;
        background-color: #fafafa;
    }
    button { 
        padding: 12px 28px; 
        font-size: 16px; 
        margin-top: 15px; 
        cursor: pointer; 
        background-color: #007bff; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        font-weight: bold;
        transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    pre { 
        background: #e9ecef; 
        padding: 20px; 
        margin-top: 20px; 
        white-space: pre-wrap; 
        border-radius: 8px; 
        border-left: 5px solid #007bff;
        font-size: 16px; 
        font-weight: 500;
        min-height: 40px;
    }
    .instruction { font-size: 0.9em; color: #666; margin-bottom: 10px; }
</style>
</head>

<body>

<h2>Lab Text → One-line Summary</h2>
<p class="instruction">วางผลแล็บลงในช่องว่าง แล้วกดปุ่ม Convert เพื่อสรุปเป็นบรรทัดเดียว</p>

<textarea id="input" placeholder="ตัวอย่าง:
Hemoglobin 8.6
WBC Count 5,030
TCO2 17 (21-32)
Protein 1+
..."></textarea>

<button onclick="convert()">Convert</button>

<pre id="output"></pre>

<script>
// แมพชื่อแล็บเต็ม -> ชื่อย่อที่ต้องการแสดง
const labMap = {
    "Hemoglobin": "Hb", "Hematocrit": "Hct", "WBC": "WBC", "Platelet": "Plt",
    "Blood Urea Nitrogen": "BUN", "Creatinine": "Cr", "eGFR": "eGFR",
    "Sodium": "Na", "Potassium": "K", "Chloride": "Cl", "TCO2": "TCO2", "CO2": "TCO2",
    "Total Protein": "Prot", "Albumin": "Alb", "Globulin": "Glob",
    "Direct Bilirubin": "DB", "Total Bilirubin": "TB",
    "Alkaline Phosphatase": "ALP", "SGOT": "AST", "AST": "AST", "SGPT": "ALT", "ALT": "ALT",
    "Spgr": "sp.gr.", "pH": "pH", "Protein": "UA Prot", "Glucose": "UA Glu", "Ketone": "UA Ketone", "Blood": "UA Blood",
    "PT": "PT", "APTT": "aPTT", "INR": "INR"
};

// แมพตัวดึงค่า Differential
const diffMap = {
    "Neutrophil": "N", "Lymphocyte": "L", "Monocyte": "M", "Eosinophil": "E", "Basophil": "B"
};

/**
 * ฟังก์ชันดึงเฉพาะตัวเลขผลแล็บ
 * แก้ไขปัญหาการดึงเลขผิดบรรทัด และการดึงเลขจากค่าปกติในวงเล็บ
 */
function extractValue(text) {
    // 1. ตัดส่วนที่เป็นค่าปกติในวงเล็บออกก่อน (ป้องกันการดึงเลข 2 จาก (21-32) ในกรณี TCO2)
    let cleanText = text.split('(')[0];
    
    // 2. ถ้าเป็นผล UA ที่มีคำว่า Neg
    if (cleanText.toLowerCase().includes("neg")) return "neg";

    // 3. ลบ Comma (,) ออกเพื่อให้เลขหลักพัน (เช่น 5,030) กลายเป็นตัวเลขต่อเนื่อง
    cleanText = cleanText.replace(/,/g, '');

    // 4. ดึงตัวเลข หรือเลขที่มีเครื่องหมายบวก (สำหรับ UA 1+, 2+)
    const m = cleanText.match(/\d+(\.\d+)?(\+)?/);
    return m ? m[0] : null;
}

function convert() {
    const rawText = document.getElementById("input").value;
    // แยกบรรทัดและลบช่องว่าง
    const lines = rawText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

    let results = new Map();
    let diff = {};
    let wbcVal = null;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // 1. ตรวจสอบ WBC Differential (ข้ามบรรทัด NRC เพื่อไม่ให้เลขกวนกัน)
        if (line.includes("WBC Differential") || Object.keys(diffMap).some(k => line.includes(k))) {
            if (!line.includes("NRC")) { 
                for (const k in diffMap) {
                    if (line.includes(k)) {
                        const val = extractValue(line);
                        if (val) diff[diffMap[k]] = val;
                    }
                }
            }
        }

        // 2. ตรวจสอบ Labs ทั่วไปตามแมพที่ตั้งไว้
        for (const key in labMap) {
            if (line.includes(key)) {
                // ข้ามถ้าเป็นหัวข้อ WBC Differential หรือบรรทัด NRC
                if (key === "WBC" && (line.includes("Differential") || line.includes("NRC"))) continue;
                // ข้าม Creatinine ถ้าเป็นปัสสาวะ (Urine)
                if (key === "Creatinine" && line.includes("Urine")) continue;
                // แยก Protein เลือดออกจาก UA Prot (UA มักมีเครื่องหมาย - นำหน้าในบาง Format)
                if (key === "Protein" && !line.startsWith("Protein") && !line.includes("- Protein") && !line.includes("Total Protein")) continue;
                // ป้องกัน TCO2 ซ้ำกับ CO2
                if (key === "CO2" && line.includes("TCO2")) continue;

                let val = extractValue(line);

                // ถ้าบรรทัดที่เจอชื่อแล็บไม่มีตัวเลข ให้ลองดูบรรทัดถัดไป
                if (!val && lines[i+1]) {
                    val = extractValue(lines[i+1]);
                }

                if (val) {
                    const label = labMap[key];
                    if (label === "WBC") {
                        // ล้าง comma/บวก และแปลงเป็นตัวเลข
                        let num = parseFloat(val.replace(/[+,]/g, ''));
                        // ปรับให้เป็นหลักพันเสมอ (ถ้ามา 4.3 -> 4300, ถ้ามา 5030 -> 5030)
                        if (num < 100) num *= 1000;
                        wbcVal = Math.round(num);
                    } else {
                        // เก็บค่าแล็บลง Map (เอาค่าแรกที่เจอ)
                        if (!results.has(label)) {
                            results.set(label, val);
                        }
                    }
                }
            }
        }
    }

    // --- การจัดรูปแบบการแสดงผล (Formatting) ---
    let finalOutput = [];

    // ใส่ WBC และ Differential ก่อนเพื่อน
    if (wbcVal) {
        const order = ["N", "L", "M", "E", "B"];
        const diffParts = order.filter(k => diff[k]).map(k => `${k}${diff[k]}%`);
        const diffText = diffParts.join(", ");
        finalOutput.push(diffText ? `WBC ${wbcVal} (${diffText})` : `WBC ${wbcVal}`);
    }

    // ลำดับการแสดงผลที่ต้องการ
    const displayOrder = [
        "Hb", "Hct", "Plt", 
        "BUN", "Cr", "eGFR",
        "Na", "K", "Cl", "TCO2",
        "Prot", "Alb", "Glob", "TB", "DB", "ALP", "AST", "ALT",
        "sp.gr.", "pH", "UA Prot", "UA Glu", "UA Ketone", "UA Blood",
        "PT", "aPTT", "INR"
    ];

    displayOrder.forEach(label => {
        if (results.has(label)) {
            finalOutput.push(`${label} ${results.get(label)}`);
        }
    });

    // เงื่อนไขพิเศษ: INR จะแสดงก็ต่อเมื่อมีผล PT มาด้วยเท่านั้น
    let finalStr = finalOutput.join(", ");
    if (!results.has("PT")) {
        // ใช้ Regex ลบ INR ออกถ้าไม่มี PT
        finalStr = finalStr.replace(/INR [\d.]+(, )?/, "").replace(/, $/, "");
    }

    // แสดงผลลัพธ์ลงบนหน้าจอ
    document.getElementById("output").textContent = finalStr || "ไม่พบข้อมูลที่สามารถแปลงได้";
}
</script>

</body>
</html>

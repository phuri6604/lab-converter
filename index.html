<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lab Converter</title>

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 20px auto;
}
textarea {
    width: 100%;
    height: 320px;
    font-family: monospace;
}
button {
    padding: 10px 18px;
    font-size: 16px;
    margin-top: 10px;
}
pre {
    background: #f5f5f5;
    padding: 12px;
    margin-top: 15px;
    white-space: pre-wrap;
}
</style>
</head>

<body>

<h2>Lab Text â†’ One-line Summary</h2>

<textarea id="input" placeholder="Paste lab text here..."></textarea>
<button onclick="convert()">Convert</button>

<pre id="output"></pre>

<script>
const labMap = {
    "Hemoglobin": "Hb",
    "Hematocrit": "Hct",
    "WBC Count": "WBC",
    "Platelet Count": "Plt",

    "Blood Urea Nitrogen": "BUN",
    "Creatinine": "Cr",
    "eGFR": "eGFR",

    "Albumin": "Alb",

    "Calcium": "Ca",
    "Phosphorus": "Phos",
    "Magnesium": "Mg",

    "Sodium": "Na",
    "Potassium": "K",
    "Chloride": "Cl",
    "TCO2": "TCO2",

    "PT": "PT",
    "APTT": "aPTT",
    "INR": "INR"
};

const diffMap = {
    "Neutrophil": "N",
    "Lymphocyte": "L",
    "Monocyte": "M",
    "Eosinophil": "E",
    "Basophil": "B"
};

function extractNumber(text) {
    const m = text.match(/-?\d+(\.\d+)?/);
    return m ? m[0] : null;
}

function convert() {
    const lines = document.getElementById("input").value
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean);

    let result = [];
    let wbc = null;
    let diff = {};

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // ðŸ”¹ WBC differential
        if (line.includes("WBC Differential")) {
            for (const k in diffMap) {
                if (line.includes(k)) {
                    const val = extractNumber(line);
                    if (val) diff[diffMap[k]] = val;
                }
            }
            continue;
        }

        // ðŸ”¹ Normal labs
        for (const key in labMap) {
            if (line.includes(key)) {
                const val =
                    extractNumber(line) ||
                    (lines[i + 1] ? extractNumber(lines[i + 1]) : null);

                if (!val) continue;

                if (labMap[key] === "WBC") {
                    wbc = val;
                } else {
                    result.push(`${labMap[key]} ${val}`);
                }
            }
        }
    }

    // ðŸ”¹ Combine WBC + diff
    if (wbc) {
        const order = ["N", "L", "M", "E", "B"];
        const diffText = order
            .filter(k => diff[k])
            .map(k => `${k}${diff[k]}%`)
            .join(", ");

        result.unshift(
            diffText ? `WBC ${wbc} (${diffText})` : `WBC ${wbc}`
        );
    }

    // ðŸ”¹ INR à¸•à¹‰à¸­à¸‡à¸¡à¸µ PT
    const hasPT = result.some(r => r.startsWith("PT "));
    if (!hasPT) {
        result = result.filter(r => !r.startsWith("INR "));
    }

    document.getElementById("output").textContent = result.join(" ");
}
</script>

</body>
</html>

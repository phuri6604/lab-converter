<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab & Vital Sign Converter (No SpO2)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 950px; margin: 20px auto; padding: 20px; color: #333; line-height: 1.5; }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8eaed; padding-bottom: 10px; }
        textarea { width: 100%; height: 300px; font-family: 'Consolas', monospace; padding: 15px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; background: #fdfdfd; }
        textarea:focus { border-color: #1a73e8; outline: none; }
        button { padding: 14px 30px; font-size: 16px; margin-top: 15px; cursor: pointer; background: #1a73e8; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #1557b0; }
        pre { background: #f1f3f4; padding: 20px; margin-top: 20px; white-space: pre-wrap; border-radius: 8px; border-left: 6px solid #1a73e8; font-size: 16px; font-weight: 500; color: #202124; min-height: 50px; }
        .label-hint { font-size: 0.85em; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<h2>Lab & Vital Sign Converter</h2>
<div class="label-hint">วางข้อมูลแล็บและ Vital Sign ลงในช่อง (จะไม่แสดง SpO2 และ Nasal Cannula ในผลลัพธ์)</div>
<textarea id="input" placeholder="ตัวอย่าง:
36.6	92	20	100	สายออกซิเจนทางจมูก	203/96
Hemoglobin 8.6
WBC Count 5,030
TCO2 17 (21-32)"></textarea>

<button onclick="convert()">Convert to Summary</button>

<pre id="output"></pre>

<script>
function convert() {
    let rawText = document.getElementById("input").value;
    let textForLab = rawText;

    // 1. ลบช่วงค่าปกติออกก่อนเพื่อความแม่นยำ (ป้องกัน TCO2 เพี้ยน)
    textForLab = textForLab.replace(/\([^)]*\)/g, ' '); 
    textForLab = textForLab.replace(/\[[^\]]*\]/g, ' ');
    textForLab = textForLab.replace(/,/g, '');

    const results = {};
    const diff = {};

    // --- ส่วนที่ 1: Vital Sign Parser (ไม่เก็บ SpO2) ---
    // ค้นหา pattern: [BT] [HR] [RR] [SpO2] ... [BP]
    const vsRegex = /(\d{2}\.\d)\s+(\d{1,3})\s+(\d{1,3})\s+(\d{1,3})\s+.*?\s+(\d{2,3}\/\d{2,3})/;
    const vsMatch = rawText.match(vsRegex);
    if (vsMatch) {
        results["BT"] = vsMatch[1];
        results["HR"] = vsMatch[2];
        results["RR"] = vsMatch[3];
        // vsMatch[4] คือ SpO2 (ข้ามไป ไม่เก็บ)
        results["BP"] = vsMatch[5];
    }

    // --- ส่วนที่ 2: Differential Parser ---
    const diffMapping = { "Neutrophil": "N", "Lymphocyte": "L", "Monocyte": "M", "Eosinophil": "E", "Basophil": "B" };
    for (let key in diffMapping) {
        const regex = new RegExp(key + "[^0-9]*(\\d+)", "i");
        const match = textForLab.match(regex);
        if (match && !textForLab.substring(match.index - 20, match.index).includes("NRC")) {
            diff[diffMapping[key]] = match[1];
        }
    }

    // --- ส่วนที่ 3: Lab Parser ---
    const labDefinitions = [
        { key: "Hemoglobin", label: "Hb" },
        { key: "Hematocrit", label: "Hct" },
        { key: "WBC", label: "WBC" },
        { key: "Platelet", label: "Plt" },
        { key: "Blood Urea Nitrogen", label: "BUN" },
        { key: "Creatinine", label: "Cr" },
        { key: "eGFR", label: "eGFR" },
        { key: "Sodium", label: "Na" },
        { key: "Potassium", label: "K" },
        { key: "Chloride", label: "Cl" },
        { key: "TCO2", label: "TCO2" },
        { key: "Total Protein", label: "Prot" },
        { key: "Albumin", label: "Alb" },
        { key: "Globulin", label: "Glob" },
        { key: "Direct Bilirubin", label: "DB" },
        { key: "Total Bilirubin", label: "TB" },
        { key: "Alkaline Phosphatase", label: "ALP" },
        { key: "SGOT", label: "AST" },
        { key: "AST", label: "AST" },
        { key: "SGPT", label: "ALT" },
        { key: "ALT", label: "ALT" },
        { key: "Spgr", label: "sp.gr." },
        { key: "pH", label: "pH" },
        { key: "PT", label: "PT" },
        { key: "APTT", label: "aPTT" },
        { key: "INR", label: "INR" }
    ];

    labDefinitions.forEach(item => {
        const regex = new RegExp("\\b" + item.key + "\\b[^0-9]*(\\d+\\.?\\d*)", "i");
        const match = textForLab.match(regex);
        if (match) {
            let val = match[1];
            if (item.label === "WBC") {
                let num = parseFloat(val);
                if (num < 100) num *= 1000;
                results["WBC"] = Math.round(num);
            } else {
                results[item.label] = val;
            }
        }
    });

    // --- ส่วนที่ 4: UA Parser ---
    const uaKeys = { "Protein": "UA Prot", "Glucose": "UA Glu", "Ketone": "UA Ketone", "Blood": "UA Blood" };
    for (let key in uaKeys) {
        const regex = new RegExp(key + "[^a-zA-Z0-9]*(Neg|neg|Positive|\\d\\+)", "i");
        const match = textForLab.match(regex);
        if (match) {
            results[uaKeys[key]] = match[1].toLowerCase() === "neg" ? "neg" : match[1];
        }
    }

    // --- ส่วนที่ 5: การจัดลำดับ Output ---
    let outputArr = [];

    // ลำดับการแสดงผล: BT, HR, RR, BP (ไม่เอา SpO2) -> CBC -> อื่นๆ
    const displayOrder = [
        "BT", "HR", "RR", "BP",         // Vital Signs (Removed SpO2)
        "Hb", "Hct", "WBC", "Plt",      // CBC (เรียงตามสั่ง)
        "BUN", "Cr", "eGFR", "Na", "K", "Cl", "TCO2",
        "Prot", "Alb", "Glob", "TB", "DB", "ALP", "AST", "ALT",
        "sp.gr.", "pH", "UA Prot", "UA Glu", "UA Ketone", "UA Blood", 
        "PT", "aPTT", "INR"
    ];

    displayOrder.forEach(label => {
        if (results[label]) {
            if (label === "WBC") {
                const dOrder = ["N", "L", "M", "E", "B"];
                const dStr = dOrder.filter(k => diff[k]).map(k => k + diff[k] + "%").join(", ");
                outputArr.push(dStr ? `WBC ${results["WBC"]} (${dStr})` : `WBC ${results["WBC"]}`);
            } else {
                outputArr.push(`${label} ${results[label]}`);
            }
        }
    });

    // เงื่อนไข: INR ต้องมี PT
    let finalStr = outputArr.join(", ");
    if (!results["PT"]) {
        finalStr = finalStr.replace(/INR [\d.]+(, )?/, "").replace(/, $/, "");
    }

    document.getElementById("output").textContent = finalStr || "ไม่พบข้อมูลที่ต้องการแปลง";
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Converter Pro (Ultra Precision)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; color: #333; line-height: 1.5; }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8eaed; padding-bottom: 10px; }
        textarea { width: 100%; height: 300px; font-family: 'Consolas', monospace; padding: 15px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; background: #fdfdfd; }
        textarea:focus { border-color: #1a73e8; outline: none; }
        button { padding: 14px 30px; font-size: 16px; margin-top: 15px; cursor: pointer; background: #1a73e8; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #1557b0; }
        pre { background: #f1f3f4; padding: 20px; margin-top: 20px; white-space: pre-wrap; border-radius: 8px; border-left: 6px solid #1a73e8; font-size: 16px; font-weight: 500; color: #202124; }
        .label-hint { font-size: 0.85em; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<h2>Lab Text → One-line Summary</h2>
<div class="label-hint">วางผลแล็บทั้งหมดลงในช่องด้านล่าง (รองรับ CBC, Chem, Electrolyte, LFT, UA, Coag)</div>
<textarea id="input" placeholder="ตัวอย่างผลแล็บ:
WBC Count 5,030
TCO2 17 (21 - 32)
Sodium 141 (135 - 145)
Protein 1+
..."></textarea>

<button onclick="convert()">Convert to Summary</button>

<pre id="output"></pre>

<script>
function convert() {
    let text = document.getElementById("input").value;

    // 1. [CRITICAL FIX] ลบช่วงค่าปกติ (Reference Range) ออกไปให้หมดก่อน
    // ลบทุกอย่างที่อยู่ใน ( ) และ [ ] เพื่อไม่ให้ตัวเลขข้างใน (เช่น 21-32) มาหลอกโปรแกรม
    text = text.replace(/\([^)]*\)/g, ' '); 
    text = text.replace(/\[[^\]]*\]/g, ' ');
    
    // 2. ลบ Comma ในตัวเลข เช่น 5,030 -> 5030
    text = text.replace(/,/g, '');

    const results = {};
    const diff = {};

    // --- ส่วนที่ 1: ดึงค่า Differential (N, L, M, E, B) ---
    const diffMapping = { "Neutrophil": "N", "Lymphocyte": "L", "Monocyte": "M", "Eosinophil": "E", "Basophil": "B" };
    for (let key in diffMapping) {
        // หาคำว่า Neutrophil แล้วเอาเลขที่ตามหลังมา (แต่ต้องไม่ใช่ NRC)
        const regex = new RegExp(key + "[^0-9]*(\\d+)", "i");
        const match = text.match(regex);
        if (match && !text.substring(match.index - 20, match.index).includes("NRC")) {
            diff[diffMapping[key]] = match[1];
        }
    }

    // --- ส่วนที่ 2: ดึงค่า Lab หลัก (ใช้ Regex ค้นหาตัวเลขที่ตามหลังชื่อแล็บ) ---
    const labDefinitions = [
        { key: "Hemoglobin", label: "Hb" },
        { key: "Hematocrit", label: "Hct" },
        { key: "WBC", label: "WBC" },
        { key: "Platelet", label: "Plt" },
        { key: "Blood Urea Nitrogen", label: "BUN" },
        { key: "Creatinine", label: "Cr" },
        { key: "eGFR", label: "eGFR" },
        { key: "Sodium", label: "Na" },
        { key: "Potassium", label: "K" },
        { key: "Chloride", label: "Cl" },
        { key: "TCO2", label: "TCO2" },
        { key: "Total Protein", label: "Prot" },
        { key: "Albumin", label: "Alb" },
        { key: "Globulin", label: "Glob" },
        { key: "Direct Bilirubin", label: "DB" },
        { key: "Total Bilirubin", label: "TB" },
        { key: "Alkaline Phosphatase", label: "ALP" },
        { key: "SGOT", label: "AST" },
        { key: "AST", label: "AST" },
        { key: "SGPT", label: "ALT" },
        { key: "ALT", label: "ALT" },
        { key: "Spgr", label: "sp.gr." },
        { key: "pH", label: "pH" },
        { key: "PT", label: "PT" },
        { key: "APTT", label: "aPTT" },
        { key: "INR", label: "INR" }
    ];

    labDefinitions.forEach(item => {
        // หาชื่อแล็บ แล้วตามด้วยตัวเลข (หรือเลขติดทศนิยม)
        // \b เพื่อให้หาคำนั้นเป๊ะๆ ไม่ให้ CO2 ไปทับ TCO2
        const regex = new RegExp("\\b" + item.key + "\\b[^0-9]*(\\d+\\.?\\d*)", "i");
        const match = text.match(regex);
        
        if (match) {
            let val = match[1];
            // จัดการ WBC: ถ้ามาเป็น 5.03 -> 5030 | ถ้ามา 5030 -> 5030
            if (item.label === "WBC") {
                let num = parseFloat(val);
                if (num < 100) num *= 1000;
                results[item.label] = Math.round(num);
            } else {
                results[item.label] = val;
            }
        }
    });

    // --- ส่วนที่ 3: ดึงค่า UA (Protein, Glu, Ketone, Blood) เพราะมีค่าเป็น 1+, 2+, Neg ---
    const uaKeys = { "Protein": "UA Prot", "Glucose": "UA Glu", "Ketone": "UA Ketone", "Blood": "UA Blood" };
    for (let key in uaKeys) {
        // หาบรรทัดที่มี UA หรือบรรทัดที่ตามหลัง Spgr/pH
        const regex = new RegExp(key + "[^a-zA-Z0-9]*(Neg|neg|Positive|\\d\\+)", "i");
        const match = text.match(regex);
        if (match) {
            results[uaKeys[key]] = match[1].toLowerCase() === "neg" ? "neg" : match[1];
        }
    }

    // --- ส่วนที่ 4: จัดเรียงลำดับการแสดงผล ---
    let outputArr = [];

    // WBC & Diff ก่อน
    if (results["WBC"]) {
        const dOrder = ["N", "L", "M", "E", "B"];
        const dStr = dOrder.filter(k => diff[k]).map(k => k + diff[k] + "%").join(", ");
        outputArr.push(dStr ? `WBC ${results["WBC"]} (${dStr})` : `WBC ${results["WBC"]}`);
    }

    const order = [
        "Hb", "Hct", "Plt", "BUN", "Cr", "eGFR", "Na", "K", "Cl", "TCO2",
        "Prot", "Alb", "Glob", "TB", "DB", "ALP", "AST", "ALT",
        "sp.gr.", "pH", "UA Prot", "UA Glu", "UA Ketone", "UA Blood", "PT", "aPTT", "INR"
    ];

    order.forEach(lab => {
        if (results[lab] && lab !== "WBC") {
            outputArr.push(`${lab} ${results[lab]}`);
        }
    });

    // เงื่อนไข: INR ต้องมี PT ถึงจะแสดง
    let finalStr = outputArr.join(", ");
    if (!results["PT"]) {
        finalStr = finalStr.replace(/INR [\d.]+(, )?/, "").replace(/, $/, "");
    }

    document.getElementById("output").textContent = finalStr || "ไม่พบข้อมูลที่ต้องการแปลง กรุณาตรวจสอบข้อมูลนำเข้า";
}
</script>

</body>
</html>

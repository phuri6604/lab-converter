<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lab Converter</title>

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 20px auto;
}
textarea {
    width: 100%;
    height: 280px;
    font-family: monospace;
}
button {
    padding: 10px 18px;
    font-size: 16px;
    margin-top: 10px;
}
pre {
    background: #f5f5f5;
    padding: 12px;
    margin-top: 15px;
    white-space: pre-wrap;
}
</style>
</head>

<body>

<h2>Lab Text → One-line Summary</h2>

<textarea id="input" placeholder="Paste lab text here..."></textarea>

<button onclick="convert()">Convert</button>

<pre id="output"></pre>

<script>
const labMap = {
    // CBC
    "Hemoglobin": "Hb",
    "Hematocrit": "Hct",
    "WBC": "WBC",
    "Platelet": "Plt",

    // Renal
    "Blood Urea Nitrogen": "BUN",
    "Creatinine": "Cr",
    "eGFR": "eGFR",

    // LFT
    "Total Protein": "TP",
    "Albumin": "Alb",
    "Globulin": "Glob",
    "Direct Bilirubin": "DBili",
    "Total Bilirubin": "TBili",
    "Alkaline Phosphatase": "ALP",
    "SGOT": "AST",
    "AST": "AST",
    "SGPT": "ALT",
    "ALT": "ALT",

    // Electrolyte / Mineral
    "Sodium": "Na",
    "Potassium": "K",
    "Chloride": "Cl",
    "TCO2": "TCO2",
    "Calcium": "Ca",
    "Phosphorus": "Phos",
    "Magnesium": "Mg",

    // Coagulation
    "PT": "PT",
    "APTT": "aPTT",
    "aPTT": "aPTT",
    "INR": "INR",

    // Other
    "Lactate": "Lactate",
    "CPK": "CPK"
};

function convert() {
    const text = document.getElementById("input").value;
    const lines = text
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean);

    let result = [];

    for (let i = 0; i < lines.length - 1; i++) {
        const name = lines[i].replace(/^-\s*/, "");

        const key = Object.keys(labMap).find(k => name.includes(k));
        if (key) {
            const next = lines[i + 1];
            if (!next.includes("ไม่พบผล")) {
                const m = next.match(/-?\d+(\.\d+)?/);
                if (m) {
                    result.push(`${labMap[key]} ${m[0]}`);
                }
            }
        }
    }

    // ⭐ INR ต้องมี PT
    const hasPT = result.some(r => r.startsWith("PT "));
    if (!hasPT) {
        result = result.filter(r => !r.startsWith("INR "));
    }

    document.getElementById("output").textContent =
        result.join(" ");
}
</script>

</body>
</html>

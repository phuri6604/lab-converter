<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Converter (TCO2 & WBC Fixed)</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 950px; 
            margin: 20px auto; 
            padding: 0 20px;
            color: #333; 
        }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        textarea { 
            width: 100%; 
            height: 350px; 
            font-family: 'Courier New', monospace; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box;
            background-color: #fafafa;
        }
        button { 
            padding: 12px 28px; 
            font-size: 16px; 
            margin-top: 15px; 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 20px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            border-radius: 8px; 
            border-left: 5px solid #28a745;
            font-size: 16px; 
            font-weight: 500;
        }
    </style>
</head>
<body>

<h2>Lab Text → One-line Summary</h2>
<textarea id="input" placeholder="Paste lab results here..."></textarea>
<button onclick="convert()">Convert</button>

<pre id="output"></pre>

<script>
const labMap = {
    "Hemoglobin": "Hb", "Hematocrit": "Hct", "WBC": "WBC", "Platelet": "Plt",
    "Blood Urea Nitrogen": "BUN", "Creatinine": "Cr", "eGFR": "eGFR",
    "Sodium": "Na", "Potassium": "K", "Chloride": "Cl", "TCO2": "TCO2", "CO2": "TCO2",
    "Total Protein": "Prot", "Albumin": "Alb", "Globulin": "Glob",
    "Direct Bilirubin": "DB", "Total Bilirubin": "TB",
    "Alkaline Phosphatase": "ALP", "SGOT": "AST", "AST": "AST", "SGPT": "ALT", "ALT": "ALT",
    "Spgr": "sp.gr.", "pH": "pH", "Protein": "UA Prot", "Glucose": "UA Glu", "Ketone": "UA Ketone", "Blood": "UA Blood",
    "PT": "PT", "APTT": "aPTT", "INR": "INR"
};

const diffMap = {
    "Neutrophil": "N", "Lymphocyte": "L", "Monocyte": "M", "Eosinophil": "E", "Basophil": "B"
};

function extractValue(text) {
    // 1. ตัดส่วนที่เป็นค่าปกติในวงเล็บออกเด็ดขาด (แก้ปัญหา TCO2 ดึงเลข 2 จาก (21-32))
    let cleanText = text.split('(')[0];
    
    // 2. ถ้ามีคำว่า Neg/Negative (กรณี UA)
    if (cleanText.toLowerCase().includes("neg")) return "neg";

    // 3. ลบ Comma (,) และเครื่องหมายลบนำหน้าออก
    cleanText = cleanText.replace(/,/g, '').replace(/^-/, '').trim();

    // 4. ดึงเฉพาะตัวเลขตัวแรกที่เจอหลังจากชื่อ Lab (รองรับทศนิยม และ 1+)
    const m = cleanText.match(/\d+(\.\d+)?(\+)?/);
    return m ? m[0] : null;
}

function convert() {
    const rawText = document.getElementById("input").value;
    const lines = rawText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

    let results = new Map();
    let diff = {};
    let wbcVal = null;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // 1. ตรวจสอบ WBC Differential
        if (line.includes("Differential") || Object.keys(diffMap).some(k => line.includes(k))) {
            if (!line.includes("NRC")) { 
                for (const k in diffMap) {
                    if (line.includes(k)) {
                        const val = extractValue(line);
                        if (val) diff[diffMap[k]] = val;
                    }
                }
            }
        }

        // 2. ตรวจสอบ Labs ทั่วไป
        for (const key in labMap) {
            // ใช้ regex แบบ word boundary (\b) เพื่อแยก CO2 กับ TCO2 ออกจากกัน
            const isMatch = new RegExp("\\b" + key + "\\b", "i").test(line) || line.includes(key);

            if (isMatch) {
                // กรองกรณีชื่อซ้ำซ้อน
                if (key === "WBC" && (line.includes("Differential") || line.includes("NRC"))) continue;
                if (key === "Creatinine" && line.includes("Urine")) continue;
                if (key === "CO2" && line.includes("TCO2")) continue;
                
                // แยกแยะ Protein เลือด (Total Protein) กับ UA Protein
                const isUA = line.includes("Spgr") || line.startsWith("- Protein") || line.includes("UA");
                if (key === "Protein") {
                    if (labMap[key] === "UA Prot" && !isUA) continue;
                    if (labMap[key] === "Prot" && isUA) continue;
                }

                let val = extractValue(line);

                // กรณีค่าอยู่บรรทัดถัดไป
                if (!val && lines[i+1]) {
                    const nextLine = lines[i+1];
                    const nextVal = extractValue(nextLine);
                    // บรรทัดถัดไปต้องไม่เป็นชื่อ Lab อื่น
                    const isAnotherLab = Object.keys(labMap).some(k => nextLine.includes(k));
                    if (nextVal && !isAnotherLab) val = nextVal;
                }

                if (val) {
                    const label = labMap[key];
                    if (label === "WBC") {
                        let num = parseFloat(val.replace(/[+,]/g, ''));
                        // Scale WBC: < 100 (เช่น 5.0) -> 5000 | 5030 -> 5030
                        if (num < 100) num *= 1000;
                        wbcVal = Math.round(num);
                    } else {
                        if (!results.has(label)) {
                            results.set(label, val);
                        }
                    }
                }
            }
        }
    }

    // --- จัดรูปแบบผลลัพธ์ ---
    let finalOutput = [];

    // WBC + Diff
    if (wbcVal) {
        const order = ["N", "L", "M", "E", "B"];
        const diffParts = order.filter(k => diff[k]).map(k => `${k}${diff[k]}%`);
        const diffText = diffParts.join(", ");
        finalOutput.push(diffText ? `WBC ${wbcVal} (${diffText})` : `WBC ${wbcVal}`);
    }

    // ลำดับการแสดงผลมาตรฐาน
    const displayOrder = [
        "Hb", "Hct", "Plt", "BUN", "Cr", "eGFR",
        "Na", "K", "Cl", "TCO2", "Prot", "Alb", "Glob", "TB", "DB", "ALP", "AST", "ALT",
        "sp.gr.", "pH", "UA Prot", "UA Glu", "UA Ketone", "UA Blood", "PT", "aPTT", "INR"
    ];

    displayOrder.forEach(label => {
        if (results.has(label)) {
            finalOutput.push(`${label} ${results.get(label)}`);
        }
    });

    // เงื่อนไข: INR ต้องมี PT
    let finalStr = finalOutput.join(", ");
    if (!results.has("PT")) {
        finalStr = finalStr.replace(/INR [\d.]+(, )?/, "").replace(/, $/, "");
    }

    document.getElementById("output").textContent = finalStr || "No results found.";
}
</script>

</body>
</html>
